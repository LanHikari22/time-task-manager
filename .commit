Partial work from branch master
